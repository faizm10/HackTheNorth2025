<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Databricks Analytics Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.5;
        }
        
        .header {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #f0f6fc;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
        }
        
        .tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            color: #8b949e;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #21262d;
            border-color: #30363d;
            color: #f0f6fc;
        }
        
        .tab:hover:not(.active) {
            background: #21262d;
            color: #c9d1d9;
        }
        
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #f0f6fc;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }
        
        .metric {
            text-align: center;
            padding: 16px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 4px;
        }
        
        .metric-label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table-header {
            background: #21262d;
            padding: 16px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #f0f6fc;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 6px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #30363d;
            color: #f0f6fc;
        }
        
        .btn-primary {
            background: #238636;
            border-color: #238636;
            color: #f0f6fc;
        }
        
        .btn-primary:hover {
            background: #2ea043;
            border-color: #2ea043;
        }
        
        .btn:disabled { 
            background: #a0a4a8; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }
        
        th {
            background: #0d1117;
            font-weight: 600;
            color: #f0f6fc;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            color: #c9d1d9;
            font-size: 14px;
        }
        
        tr:hover {
            background: #21262d;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-success {
            background: #1a472a;
            color: #3fb950;
        }
        
        .status-error {
            background: #5d1a1a;
            color: #f85149;
        }
        
        .json-viewer {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-size: 12px;
            color: #c9d1d9;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
        
        .error {
            background: #5d1a1a;
            border: 1px solid #f85149;
            color: #f85149;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }
        
        .empty-state::before {
            content: "üìä";
            font-size: 48px;
            display: block;
            margin-bottom: 16px;
        }
        
        .chart-container {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #8b949e;
            position: relative;
        }
        
        .chart-bar {
            display: flex;
            align-items: end;
            gap: 4px;
            height: 100%;
            padding: 20px;
        }
        
        .bar {
            background: linear-gradient(to top, #58a6ff, #1f6feb);
            border-radius: 2px 2px 0 0;
            min-width: 8px;
            transition: all 0.3s ease;
        }
        
        .bar:hover {
            background: linear-gradient(to top, #79c0ff, #388bfd);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        
        .data-item {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
        }
        
        .data-label {
            font-size: 11px;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .data-value {
            font-size: 18px;
            font-weight: 700;
            color: #f0f6fc;
        }
        
        .distribution-chart {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 120px;
            padding: 10px;
        }
        
        .dist-bar {
            background: linear-gradient(to top, #238636, #2ea043);
            border-radius: 1px 1px 0 0;
            min-width: 4px;
            flex: 1;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .input-group label {
            font-size: 12px;
            color: #8b949e;
            font-weight: 500;
        }
        
        input[type="text"], select {
            padding: 8px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }
        
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
        }
        
        select {
            cursor: pointer;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üìä Databricks Analytics</div>
        <div class="nav-tabs">
            <div class="tab active" onclick="showTab('overview')">Overview</div>
            <div class="tab" onclick="showTab('results')">Results</div>
            <div class="tab" onclick="showTab('analytics')">Analytics</div>
            <div class="tab" onclick="showTab('detailed-user')">üë§ Detailed User</div>
        </div>
    </div>

    <div class="main-content">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content">
            <div class="controls">
                <div class="input-group">
                    <label>Data Source</label>
                    <select id="dataSource" onchange="switchDataSource()">
                        <option value="mock">üìä Mock Analytics Data</option>
                        <option value="supabase">‚òÅÔ∏è Supabase Results</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>API Endpoint</label>
                    <input type="text" id="apiUrl" value="http://localhost:3001/api/mock-data" />
                </div>
                <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh Data</button>
            </div>
            
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìà Processing Metrics</div>
                    </div>
                    <div class="metric-grid" id="metrics">
                        <div class="metric">
                            <div class="metric-value" id="totalResults">-</div>
                            <div class="metric-label">Total Results</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="successRate">-</div>
                            <div class="metric-label">Success Rate</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="avgChunks">-</div>
                            <div class="metric-label">Avg Chunks</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="avgModules">-</div>
                            <div class="metric-label">Avg Modules</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="avgRequirements">-</div>
                            <div class="metric-label">Avg Requirements</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="avgTextLength">-</div>
                            <div class="metric-label">Avg Text Length</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Processing Volume Trends</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-bar" id="volumeChart">
                            <!-- Volume bars will be generated here -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üéØ Performance Analytics</div>
                    </div>
                    <div class="data-grid" id="performanceMetrics">
                        <!-- Performance metrics will be generated here -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìà Text Length Distribution</div>
                    </div>
                    <div class="chart-container">
                        <div class="distribution-chart" id="textLengthChart">
                            <!-- Distribution bars will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="tab-content hidden">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üìã Processing Results</div>
                    <div class="table-actions">
                        <button class="btn" onclick="exportData()">üì• Export</button>
                        <button class="btn btn-primary" onclick="loadData()">üîÑ Refresh</button>
                    </div>
                </div>
                <div id="resultsTable">
                    <div class="loading">Loading results...</div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content hidden">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üîç Module Distribution Analysis</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-bar" id="moduleDistributionChart">
                            <!-- Module distribution bars will be generated here -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìä Requirement Priority Breakdown</div>
                    </div>
                    <div class="chart-container">
                        <div class="distribution-chart" id="priorityChart">
                            <!-- Priority distribution bars will be generated here -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">‚ö° Processing Efficiency</div>
                    </div>
                    <div class="data-grid" id="efficiencyMetrics">
                        <!-- Efficiency metrics will be generated here -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìà Content Complexity Trends</div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-line" id="complexityChart">
                            <!-- Complexity trend line will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed User Tab -->
        <div id="detailed-user" class="tab-content hidden">
            <div class="controls">
                <button class="btn btn-primary" onclick="loadDetailedUser()">üîÑ Load Detailed User Profile</button>
            </div>
            <div id="detailedUserContent">
                <div class="loading">Click "Load Detailed User Profile" to see comprehensive user data</div>
            </div>
        </div>
    </div>

    <script>
        let allResults = [];
        let mockData = null;
        let currentDataSource = 'mock';
        
        function switchDataSource() {
            const dataSource = document.getElementById('dataSource').value;
            const apiUrl = document.getElementById('apiUrl');
            
            if (dataSource === 'mock') {
                apiUrl.value = 'http://localhost:3001/api/mock-data';
                currentDataSource = 'mock';
            } else {
                apiUrl.value = 'http://localhost:3001/api/results';
                currentDataSource = 'supabase';
            }
            
            loadData();
        }
        
        async function loadData() {
            const apiUrl = document.getElementById('apiUrl').value;
            const loadingEl = document.getElementById('resultsTable');
            
            try {
                loadingEl.innerHTML = '<div class="loading">Loading data...</div>';
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                if (currentDataSource === 'mock') {
                    mockData = data.data;
                    allResults = []; // Clear Supabase results
                    updateMockDataOverview();
                    updateMockDataTable();
                } else {
                    allResults = Array.isArray(data.data) ? data.data : [];
                    mockData = null; // Clear mock data
                    updateOverview();
                    updateResultsTable();
                }
                
            } catch (error) {
                loadingEl.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function updateMockDataOverview() {
            if (!mockData) return;
            
            const { summary, performance } = mockData;
            
            // Update main metrics
            document.getElementById('totalResults').textContent = summary.total_users.toLocaleString();
            document.getElementById('successRate').textContent = `${Math.round(summary.completion_rate * 100)}%`;
            document.getElementById('avgChunks').textContent = summary.total_lessons.toLocaleString();
            document.getElementById('avgModules').textContent = summary.total_quizzes.toLocaleString();
            document.getElementById('avgRequirements').textContent = summary.active_users_today.toLocaleString();
            document.getElementById('avgTextLength').textContent = Math.round(summary.avg_quiz_score).toString();
            
            // Update charts with mock data
            updateMockVolumeChart();
            updateMockPerformanceMetrics();
            updateMockTextLengthChart();
            updateMockAnalyticsCharts();
        }
        
        function updateMockVolumeChart() {
            const chart = document.getElementById('volumeChart');
            if (!mockData?.performance) {
                chart.innerHTML = '<div style="color: #8b949e;">No data available</div>';
                return;
            }
            
            const performance = mockData.performance.slice(-7); // Last 7 days
            const maxUsers = Math.max(...performance.map(p => p.active_users));
            
            chart.innerHTML = performance.map(day => {
                const height = (day.active_users / maxUsers) * 100;
                const date = new Date(day.date).toLocaleDateString();
                return `<div class="bar" style="height: ${height}%" title="${date}: ${day.active_users} users"></div>`;
            }).join('');
        }
        
        function updateMockPerformanceMetrics() {
            const container = document.getElementById('performanceMetrics');
            if (!mockData?.performance) {
                container.innerHTML = '<div style="color: #8b949e; text-align: center; padding: 20px;">No data available</div>';
                return;
            }
            
            const performance = mockData.performance;
            const latest = performance[performance.length - 1];
            
            container.innerHTML = `
                <div class="data-item">
                    <div class="data-label">Daily Active Users</div>
                    <div class="data-value">${latest.active_users.toLocaleString()}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(latest.active_users / 1200) * 100}%"></div>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-label">Lessons Completed</div>
                    <div class="data-value">${latest.lessons_completed.toLocaleString()}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(latest.lessons_completed / 400) * 100}%"></div>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-label">Daily Revenue</div>
                    <div class="data-value">$${latest.revenue.toLocaleString()}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(latest.revenue / 15000) * 100}%"></div>
                    </div>
                </div>
                <div class="data-item">
                    <div class="data-label">Churn Rate</div>
                    <div class="data-value">${(latest.churn_rate * 100).toFixed(1)}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(latest.churn_rate / 0.08) * 100}%"></div>
                    </div>
                </div>
            `;
        }
        
        function updateMockTextLengthChart() {
            const chart = document.getElementById('textLengthChart');
            if (!mockData?.lessons) {
                chart.innerHTML = '<div style="color: #8b949e;">No data available</div>';
                return;
            }
            
            // Group lessons by duration buckets
            const buckets = [15, 30, 45, 60, 90, 120];
            const bucketCounts = new Array(buckets.length).fill(0);
            
            mockData.lessons.forEach(lesson => {
                for (let i = 0; i < buckets.length; i++) {
                    if (lesson.duration_minutes <= buckets[i]) {
                        bucketCounts[i]++;
                        break;
                    }
                }
            });
            
            const maxCount = Math.max(...bucketCounts);
            
            chart.innerHTML = bucketCounts.map((count, i) => {
                const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
                const label = `‚â§${buckets[i]}min`;
                return `<div class="dist-bar" style="height: ${height}%" title="${label}: ${count} lessons"></div>`;
            }).join('');
        }
        
        function updateMockAnalyticsCharts() {
            updateMockModuleDistributionChart();
            updateMockPriorityChart();
            updateMockEfficiencyMetrics();
        }
        
        function updateMockModuleDistributionChart() {
            const chart = document.getElementById('moduleDistributionChart');
            if (!mockData?.lessons) {
                chart.innerHTML = '<div style="color: #8b949e;">No data available</div>';
                return;
            }
            
            // Group lessons by topic
            const topicCounts = {};
            mockData.lessons.forEach(lesson => {
                topicCounts[lesson.topic] = (topicCounts[lesson.topic] || 0) + 1;
            });
            
            const sortedTopics = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8); // Top 8 topics
            
            const maxCount = Math.max(...sortedTopics.map(([,count]) => count));
            
            chart.innerHTML = sortedTopics.map(([topic, count]) => {
                const height = (count / maxCount) * 100;
                return `<div class="bar" style="height: ${height}%" title="${topic}: ${count} lessons"></div>`;
            }).join('');
        }
        
        function updateMockPriorityChart() {
            const chart = document.getElementById('priorityChart');
            if (!mockData?.lessons) {
                chart.innerHTML = '<div style="color: #8b949e;">No data available</div>';
                return;
            }
            
            const difficultyCounts = { beginner: 0, intermediate: 0, advanced: 0 };
            mockData.lessons.forEach(lesson => {
                difficultyCounts[lesson.difficulty]++;
            });
            
            const maxCount = Math.max(...Object.values(difficultyCounts));
            const difficulties = ['beginner', 'intermediate', 'advanced'];
            
            chart.innerHTML = difficulties.map(difficulty => {
                const count = difficultyCounts[difficulty];
                const height = (count / maxCount) * 100;
                return `<div class="dist-bar" style="height: ${height}%" title="${difficulty}: ${count} lessons"></div>`;
            }).join('');
        }
        
        function updateMockEfficiencyMetrics() {
            const container = document.getElementById('efficiencyMetrics');
            if (!mockData?.summary) {
                container.innerHTML = '<div style="color: #8b949e; text-align: center; padding: 20px;">No data available</div>';
                return;
            }
            
            const { summary } = mockData;
            
            container.innerHTML = `
                <div class="data-item">
                    <div class="data-label">Avg Quiz Score</div>
                    <div class="data-value">${Math.round(summary.avg_quiz_score)}%</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Completion Rate</div>
                    <div class="data-value">${Math.round(summary.completion_rate * 100)}%</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Total Users</div>
                    <div class="data-value">${summary.total_users.toLocaleString()}</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Active Today</div>
                    <div class="data-value">${summary.active_users_today.toLocaleString()}</div>
                </div>
            `;
        }
        
        function updateMockDataTable() {
            const container = document.getElementById('resultsTable');
            if (!mockData?.users) {
                container.innerHTML = '<div class="empty-state">No data available</div>';
                return;
            }
            
            const users = mockData.users.slice(0, 50); // Show first 50 users
            
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Subscription</th>
                            <th>Lessons</th>
                            <th>Quizzes</th>
                            <th>Avg Score</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><code>${user.user_id}</code></td>
                                <td>${user.name}</td>
                                <td><span class="status-badge ${user.subscription_tier === 'enterprise' ? 'status-success' : user.subscription_tier === 'premium' ? 'status-success' : 'status-error'}">${user.subscription_tier}</span></td>
                                <td>${user.total_lessons}</td>
                                <td>${user.total_quizzes}</td>
                                <td>${Math.round(user.avg_score)}%</td>
                                <td>${new Date(user.last_active).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn" onclick="viewUserDetails('${user.user_id}')">üëÅÔ∏è View</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }
        
        function viewUserDetails(userId) {
            if (!mockData?.users) return;
            
            const user = mockData.users.find(u => u.user_id === userId);
            if (!user) return;
            
            const details = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: #161b22; border: 1px solid #30363d; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; width: 100%;">
                        <div style="padding: 20px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: #f0f6fc;">User Details: ${user.name}</h3>
                            <button class="btn" onclick="closeDetails()">‚úï</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="data-grid">
                                <div class="data-item">
                                    <div class="data-label">User ID</div>
                                    <div class="data-value">${user.user_id}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Email</div>
                                    <div class="data-value">${user.email}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Subscription</div>
                                    <div class="data-value">${user.subscription_tier}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Total Lessons</div>
                                    <div class="data-value">${user.total_lessons}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Total Quizzes</div>
                                    <div class="data-value">${user.total_quizzes}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Average Score</div>
                                    <div class="data-value">${Math.round(user.avg_score)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', details);
        }
        
        function closeDetails() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        // Detailed user functions
        async function loadDetailedUser() {
            const container = document.getElementById('detailedUserContent');
            
            try {
                container.innerHTML = '<div class="loading">Loading detailed user profile...</div>';
                
                const response = await fetch('http://localhost:3001/api/detailed-user');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                displayDetailedUser(data.data);
                
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        function displayDetailedUser(user) {
            const container = document.getElementById('detailedUserContent');
            
            const html = `
                <div class="dashboard-grid">
                    <!-- User Profile Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üë§ User Profile</div>
                        </div>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Name</div>
                                <div class="data-value">${user.name}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Email</div>
                                <div class="data-value">${user.email}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Location</div>
                                <div class="data-value">${user.profile.location}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Occupation</div>
                                <div class="data-value">${user.profile.occupation}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Experience</div>
                                <div class="data-value">${user.profile.experience_level}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Subscription</div>
                                <div class="data-value">${user.subscription_tier}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Learning Stats Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Learning Statistics</div>
                        </div>
                        <div class="metric-grid">
                            <div class="metric">
                                <div class="metric-value">${user.stats.total_lessons}</div>
                                <div class="metric-label">Lessons Completed</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${user.stats.total_quizzes}</div>
                                <div class="metric-label">Quizzes Taken</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${user.stats.avg_score}%</div>
                                <div class="metric-label">Average Score</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${Math.round(user.stats.total_study_time / 60)}h</div>
                                <div class="metric-label">Study Time</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${user.stats.streak_days}</div>
                                <div class="metric-label">Day Streak</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${user.stats.certificates_earned}</div>
                                <div class="metric-label">Certificates</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Lessons Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìö Recent Lessons (Last 10)</div>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${user.learning_journey.lessons_completed.slice(-10).reverse().map(lesson => `
                                <div style="padding: 8px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #f0f6fc;">${lesson.title}</div>
                                        <div style="font-size: 12px; color: #8b949e;">${lesson.topic} ‚Ä¢ ${lesson.time_spent}min</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600; color: #58a6ff;">${lesson.score}%</div>
                                        <div style="font-size: 12px; color: #8b949e;">${new Date(lesson.completed_at).toLocaleDateString()}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Achievements Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üèÜ Achievements</div>
                        </div>
                        <div class="data-grid">
                            ${user.learning_journey.achievements.map(achievement => `
                                <div class="data-item">
                                    <div class="data-label">${achievement.name}</div>
                                    <div class="data-value">+${achievement.points} pts</div>
                                    <div style="font-size: 11px; color: #8b949e; margin-top: 4px;">${achievement.description}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Study Sessions Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìÖ Recent Study Sessions (Last 7 Days)</div>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${user.learning_journey.study_sessions.slice(-7).reverse().map(session => `
                                <div style="padding: 8px; border-bottom: 1px solid #30363d;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600; color: #f0f6fc;">${new Date(session.start_time).toLocaleDateString()}</div>
                                            <div style="font-size: 12px; color: #8b949e;">
                                                ${new Date(session.start_time).toLocaleTimeString()} - ${new Date(session.end_time).toLocaleTimeString()}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600; color: #58a6ff;">${Math.round(session.duration / 60)}h ${session.duration % 60}m</div>
                                            <div style="font-size: 12px; color: #8b949e;">${session.lessons_studied} lessons, ${session.quizzes_taken} quizzes</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Social & Preferences Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üë• Social & Preferences</div>
                        </div>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Friends</div>
                                <div class="data-value">${user.social.friends_count}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Study Groups</div>
                                <div class="data-value">${user.social.study_groups.length}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Forum Posts</div>
                                <div class="data-value">${user.social.forum_posts}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Helpful Votes</div>
                                <div class="data-value">${user.social.helpful_votes_received}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Study Preference</div>
                                <div class="data-value">${user.preferences.study_time_preference}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Learning Style</div>
                                <div class="data-value">${user.preferences.learning_style}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Raw Data Section -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <div class="card-title">üîç Complete User Data (JSON)</div>
                    </div>
                    <details>
                        <summary><strong>Click to view complete user data</strong></summary>
                        <div class="json-viewer">${JSON.stringify(user, null, 2)}</div>
                    </details>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active');
        }
        
        function exportData() {
            if (currentDataSource === 'mock' && mockData?.users) {
                const csv = [
                    ['User ID', 'Name', 'Subscription', 'Lessons', 'Quizzes', 'Avg Score', 'Last Active'],
                    ...mockData.users.slice(0, 50).map(user => [
                        user.user_id,
                        user.name,
                        user.subscription_tier,
                        user.total_lessons,
                        user.total_quizzes,
                        Math.round(user.avg_score),
                        new Date(user.last_active).toLocaleDateString()
                    ])
                ].map(row => row.join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (allResults.length > 0) {
                const csv = [
                    ['ID', 'Status', 'Created', 'Text Length', 'Chunks', 'Modules', 'Requirements'],
                    ...allResults.map(r => [
                        r.id || 'N/A',
                        r.success ? 'Success' : 'Failed',
                        r.created_at || 'N/A',
                        r.metadata?.textLength || 'N/A',
                        r.metadata?.chunkCount || 'N/A',
                        r.metadata?.moduleCount || 'N/A',
                        r.metadata?.requirementCount || 'N/A'
                    ])
                ].map(row => row.join(',')).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `processing-results-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('No data to export');
            }
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>